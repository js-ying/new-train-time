name: Deploy to Ubuntu Server

on:
  push:
    branches:
      - main # 或你希望觸發部署的分支

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # - name: Checkout code
      #   uses: actions/checkout@v2

      # - name: Setup Node.js
      #   uses: actions/setup-node@v2
      #   with:
      #     node-version: "20" # 根據需要選擇 Node.js 版本

      # - name: Install dependencies
      #   run: npm install

      # - name: Build project
      #   run: npm run build

      - name: Deploy to server
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            echo "Connected to server"
            source ~/.zshrc
            nvm use v20
            node -v
            pm2 --version
            cd /var/www/html/jsy.tw/fullstack/new-train-time

            # 強制捨棄伺服器上自發性的變動（如自動更新的 package-lock.json）
            git reset --hard

            # 強制拉取並對齊遠端的 main 分支，解決 master/main 分支命名不一致問題
            git fetch origin main
            git checkout -B main origin/main

            # 清理未被 git 追蹤的暫存檔（配合 .gitignore）
            git clean -fd

            # 使用 npm ci (Clean Install) 確保依賴版本與開發環境完全一致，且不會修改 lock 檔
            # 若 npm ci 失敗（通常是因為環境極端差異），則退回 npm install
            npm ci || npm install

            # 重新編譯
            rm -rf .next
            npm run build

            # 重啟服務並確認狀態
            pm2 restart new-train-time
            pm2 show new-train-time | grep -E "status|path"
